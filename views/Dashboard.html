<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap/bootstrap-5.3.2-dist/css/bootstrap.css">
    <link rel="stylesheet" href="css/fontawesome/fontawesome-free-6.4.2-web/css/all.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/bootstrap.bundle.js"></script>
    <title>Dashboard</title>
</head>
<body>

    <!-- Main Page Header -->
    <header class="main-page-header mb-3 bg-primary">
        <!-- Container-->
        <div class="container d-flex align-items-center">
           <!-- Company Name -->
           <div class="company-name">
              Evergreen Bank
           </div>
           <!-- Company Name -->

           <!-- Navigation -->
           <nav class="navigation">
             <li><a href="">Dashboard</a></li>
             <li><a href="/payment">Payment History</a></li>
             <li><a href="/history">Transaction History</a></li>
           </nav>
           <!-- End Of Navigation -->

           <!-- Display Name -->
           <div class="display-name ms-auto text-white">
              <i class="fa fa-circle text-success me-2"></i> Welcome: <span id="name"></span>
           </div>
           <!-- End Of Display Name -->

           <!-- Log Out Button -->
           <a href="" class="btn btn-sm text-white ms-4">
              <i class="fa fa-sign-out-alt"></i> <a href="/login" class="btn btn-sm text-white">Sign Out</a>
           </a>
           <!-- End Of Log Out Button -->
        </div>
        <!-- End of Container-->
    </header>
    <!-- Main Page Header -->

       <!-- Start Of Transact OffCanvas -->
  
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title text-white" id="offcanvasExampleLabel">Transact</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <!-- Offcanvas: Transact Body-->
        <div class="offcanvas-body">
            <small class="card-text">
                Choose an Option below to perform a Transaction
            </small>
           <!-- Transaction Type Drop down List -->
           <select name="transact-type" class="form-control my-3" id="transact-type">
              <option value="">-- Select Transaction Type --</option>
              <option value="payment">Payment</option>
              <option value="transfer">Transfer</option>
              <option value="deposit">Deposit</option>
              <option value="withdraw">Withdraw</option>
           </select>
           <!-- End Of Transaction Type Drop down List -->

           <!-- Card: Payment Card -->
           <div class="card payment-card">
              <!-- Card Body -->
              <div class="card-body">
                  <!-- Form Group -->
                  <div class="form-group mb-2">
                      <label for=""> Account Holder  / Beneficiary</label>
                      <input type="text" name="beneficiary" class="form-control" placeholder = "Enter Account Holder / Beneficiary Name">
                  </div>
                  <!-- End Of Form Group -->

                  <!-- Form Group -->
                  <div class="form-group mb-2">
                     <label for="">  Beneficiary Account Number</label>
                     <input type="text" name="account_number" class="form-control" placeholder = "Enter Account Holder / Beneficiary Account Number">
                  </div>
                  <!-- End Of Form Group -->
                
                  <!-- Form Group-->
                  <div class="form-group">
                      <label for="">Select Account</label>
                      <!-- Select Account Option -->
                      <select name="account_id" class="form-control account-select" id="account_id">
                         <option value="">-- Select Account --</option>
                      </select>
                      <!-- End Of Select Account Option -->
                  </div>
                  <!-- End Of Group-->
                  <!-- Form Group -->
                  <div class="form-group mb-2">
                     <label for=""> Reference</label>
                     <input type="text" name="reference" class="form-control" placeholder = "Enter Reference">
                   </div>
                   <!-- End Of Form Group -->

                   <!-- Form Group -->
                  <div class="form-group mb-2">
                      <label for="">  Enter Payment Amount</label>
                      <input type="text" name="payment_amount" class="form-control" placeholder = "Enter Payment Amount">
                  </div>
                  <!-- End Of Form Group -->
                
                   <!-- Form Group -->
                    <div class="form-group mb-2">

                      <button id="payButton" class="btn btn-md transact-btn">Pay</button>

                    </div>
                    <!-- End Of Form Group -->


                </div>
                <!-- End Of Card Body -->

            </div>
           <!-- End Of Card: Payment Card -->
           
           <!-- Card: Transfer Card -->
           <div class="card transfer-card">
               <!-- Card Body -->
               <div class="card-body">
                    <!-- Form Group-->
                   <div class="form-group">
                      <label for="">Select Account</label>
                      <!-- Select Account Option -->
                      <select name="account_bene" class="form-control account-select" id="beneSelect">
                         <option value="">-- Select Account --</option>
                      </select>
                      <!-- End Of Select Account Option -->
                  </div>
                  <!-- End Of Group-->

                   <!-- Form Group-->
                   <div class="form-group">
                      <label for="">Select Account</label>
                      <!-- Select Account Option -->
                      <select name="account_sender" class="form-control account-select" id="senderSelect">
                          <option value="">-- Select Account --</option>
                      </select>
                      <!-- End Of Select Account Option -->
                   </div>
                   <!-- End Of Group-->                  


                  <!-- Form Group -->
                  <div class="form-group mb-2">
                      <label for="">  Enter transfer Amount</label>
                      <input type="text" name="transfer_amount" class="form-control" placeholder = "Enter Transfer Amount">
                  </div>
                 <!-- End Of Form Group -->
              
                 <!-- Form Group -->
                   <div class="form-group mb-2">
                      <button id="transferButton" class="btn btn-md transact-btn">Transfer</button>
                   </div>
                  <!-- End Of Form Group -->
                </div>
                <!-- End Of Card Body -->

            </div>
          <!-- End Of Card: transfer Card -->

           <!-- Card: Deposit Card -->
           <div class="card deposit-card">
                <!-- Card Body -->
                <div class="card-body">
                    <!-- Deposit Form -->
                    <form action="" class="deposit">

                        <!-- Form Group -->
                        <div class="form-group mb-2">
                           <label for="">  Enter Deposit Amount</label>
                           <input type="text" name="depo_amount" class="form-control" placeholder = "Enter Deposit Amount" value="">
                       </div>
                       <!-- End Of Form Group -->                


                        <!-- Form Group-->
                        <div class="form-group">
                           <label for="">Select Account</label>
                           <!-- Select Account Option -->
                           <select name="account_depo" class="form-control account-select" id="accountSelect">
                                <option value="">-- Select Account --</option>
                           </select>
                           <!-- End Of Select Account Option -->
                      </div>
                      <!-- End Of Group-->                  
         
                      <!-- Form Group -->
                      <div class="form-group my-2">
                          <button id="depoBtn" class="btn btn-md transact-btn">Deposit</button>
                      </div>
                      <!-- End Of Form Group -->

                    </form>
                    <!-- End Of Deposit Form -->
                </div>
                <!-- End Of Card Body -->

            </div>
            <!-- End Of Card: Deposit Card --> 

            <!-- Card: Withdraw Card -->
            <div class="card withdraw-card">
                <!-- Card Body -->
                <div class="card-body">
            
                    <!-- Deposit Form -->
                    <form action="" class="deposit">

                        <!-- Form Group -->
                        <div class="form-group mb-2">
                           <label for="">  Enter Withdraw Amount</label>
                           <input type="text" name="withdraw_amount" class="form-control" placeholder = "Enter Withdraw Amount">
                       </div>
                       <!-- End Of Form Group -->                


                        <!-- Form Group-->
                        <div class="form-group">
                           <label for="">Select Account</label>
                           <!-- Select Account Option -->
                           <select name="account_wdraw" class="form-control account-select" id="accountSelect">
                                <option value="">-- Select Account --</option>
                           </select>
                           <!-- End Of Select Account Option -->
                      </div>
                      <!-- End Of Group-->                  
         
                      <!-- Form Group -->
                      <div class="form-group my-2">
                          <button id="wdrawBtn" class="btn btn-md transact-btn">Withdraw</button>
                      </div>
                      <!-- End Of Form Group -->

                    </form>
                    <!-- End Of Withdraw Form -->            
              </div>
              <!-- End Of Card Body -->
            </div>
            <!-- End Of Card: Withdraw Card -->

        </div>
        <!-- End Of Offcanvas: Transact Body-->

    </div>
    <!-- End Of Start Transact OffCanvas -->
        
    <!-- Right Side OffCanvas: Accounts Form Container -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvasRightLabel" class="text-white">Create / Add an Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <!-- OffCanvas Body: Accounts Form Wrapper -->
        <div class="offcanvas-body">
           <!-- Card: Accounts Form Card -->
           <div class="card">
              <!-- Card Body-->
              <div class="card-body">
                   <form action="" class="add-account-form">
                      <!-- Form Group-->
                      <div class="form-group mb-3">
                          <label for="">Enter Account Name</label>
                          <input type="text" name="account_name" id="accountName" class="form-control" placeholder = "Enter Account Name">
                      </div>
                      <!-- End Of Form Group-->

                      <!-- Form Group-->
                      <div class="form-group mb-3">
                           <label for=""> Select Account Type </label>
                           <select name="account_type" class="form-control" id="accountType">
                              <option value="">-- Select Account Type --</option>
                              <option value="Check">Check</option>
                              <option value="Savings">Savings</option>
                              <option value="Business">Business</option>
                           </select>
                      </div>
                      <!-- End Of Form Group-->
                      
                      <!-- Form Group -->
                      <div class="form-group my-2">
                         <button id="addAccountBtn" class="btn btn-md transact-btn">Add Account</button>
                      </div>
                      <!-- End Of Form Group -->                      
                   </form>
               </div>
               <!-- End Of Card Body-->
           </div>
           <!-- End Of Card: Accounts Form Card -->
        </div>
        <!-- End Of OffCanvas Body: Accounts Form Wrapper -->
            
    </div>
    <!-- End Of Right Side OffCanvas : Accounts Form Container -->

    <!-- Container -->
    <div class="container d-flex">
            
        <button id= "add-account-btn" class="btn btn-lg shadow" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
            <i class="fa fa-credit-card"></i>Add New Account 
        </button>
         
        <!-- Transaction Button -->
        <button id="transact-btn"class="btn btn-lg ms-auto shadow" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
            <i class="fa fa-wallet"></i>Transact
        </button>
        <!-- End Of Transaction Button -->
 
    </div>
    <!-- End of Container -->

    <!-- Container: Total Accounts Balance Display-->
    <div class="container d-flex py-3">
        <h2 class="me-auto">Total Accounts Balance:</h2>
        <h2 class="ms-auto" id="totalBalance">0.00</h2>
    </div>
    <!-- End Of Container: Total Accounts Balance Display-->

    <!-- Container: Accordion Menu / Drop Down -->
    <div class="container">
        <!-- Accordion Menu / Drop Down -->
        <div class="accordion accordion-flush" id="accordionFlushExample">
           
          <!-- End Of Accordion Menu / Drop Down -->
        </div>
    <!-- End Of Container: Accordion Menu / Drop Down -->

    <!-- Container: No Accounts -->
    <div class="container" id="noAccountsContainer">
        <!-- Card: No Accounts -->
        <div class="card no-accounts-card">
            <!-- Card body-->
            <div class="card-body">
                <!-- Card Title -->
                <h1 class="card-title">
                    <i class="fas fa-ban text-danger"></i> No Registered Account
                </h1>
                <!-- End Of Card Title -->
                <hr>
                 <!-- Card Text -->
                 <div class="card-text">
                    You are currently do not have any registered accounts. <br>
                    Please click below to to register / add a new account.
                 </div>
                 <!-- End Of Card Text -->
                 <br>

                <button id= "" class="btn btn-primary btn btn-lg shadow" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                    <i class="fa fa-credit-card"></i>Add New Account 
                 </button>

            </div>
            <!-- End Of Card body-->
        </div>
        <!-- End Of Card: No Accounts -->
        
    </div>
    <!-- End Of Container: No Accounts -->
    


    <script src="js/main.js"></script>
    <script defer>
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Fetch user data
          const urlSearchParams = new URLSearchParams(window.location.search);
          const userId = urlSearchParams.get('id');
          const navigationLinks = document.querySelectorAll('.navigation a');
          navigationLinks.forEach(link => {
              const href = link.getAttribute('href');
              link.setAttribute('href', `${href}?id=${userId}`);
          });
          
          if (!userId) {
            // alert('You need to sign in to view this page');
            throw new Error('User ID not found in the URL');
            // location.href = '/index';
          }
    
          const response = await fetch(`http://localhost:9000/api/user/${userId}`);
          
          if (!response.ok) {
            throw new Error('Failed to fetch user data');
          }
    
          const userData = await response.json();
          console.log(userData);
    
          // Display user name
          document.getElementById('name').innerText = `${userData.first_name} ${userData.last_name}`;
    
          // Show/hide the container based on whether the user has accounts
          const hasAccounts = userData.Accounts.length > 0;
          document.getElementById('noAccountsContainer').style.display = hasAccounts ? 'none' : 'block';
    
          // Populate select options based on user's accounts
          const selectAccounts = document.querySelectorAll('.account-select');

          selectAccounts.forEach(selectAccount => {
              userData.Accounts.forEach(account => {
                  const option = document.createElement('option');
                  option.value = account.account_no;
                  option.text = account.account_name;
                  selectAccount.add(option);
              });
          });
    
          // Event listener for the "Pay" button
          const payButton = document.getElementById('payButton');
          payButton.addEventListener('click', () => {
            // const selectedAccount = selectAccount.value;
            // const sender = document.getElementsByName('account_id').value;
            const sender = document.getElementById('account_id').value;
            const beneficiary = document.querySelector('input[name="beneficiary"]').value;
            const accountNumber = document.querySelector('input[name="account_number"]').value;
            const reference = document.querySelector('input[name="reference"]').value;
            const paymentAmount = document.querySelector('input[name="payment_amount"]').value;
            console.log(sender, beneficiary, accountNumber, reference, paymentAmount);
            // Check if all required fields are filled
            if (!sender || !beneficiary || !accountNumber || !reference || !paymentAmount) {
              alert('Please fill in all required fields');
              return;
            }
            
            // Make a POST request to localhost:9000/api/payment with the specified data
            fetch('http://localhost:9000/api/payment', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: beneficiary,
                account_no: accountNumber,
                sender: sender,
                amount: paymentAmount,
                reference: reference,
              }),
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to make payment');
                  location.reload();
                }
                alert('Payment successful!');
                location.reload();
              })
              .catch(error => {
                console.error('Error:', error.message);
                alert('Failed to make payment. Please try again.');
                location.reload();
              });
          });
          
          
          // Calculate total balance
          const totalBalance = userData.Accounts.reduce((acc, account) => acc + account.balance, 0);
          document.getElementById('totalBalance').innerText = totalBalance.toFixed(2);
    
          // Generate accordion items for each account
          const accordionContainer = document.getElementById('accordionFlushExample');
    
          userData.Accounts.forEach((account, index) => {
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
    
            accordionItem.innerHTML = `
              <h2 class="accordion-header" id="flush-heading${index}">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse${index}" aria-expanded="false" aria-controls="flush-collapse${index}">
                  ${account.account_type}
                </button>
              </h2>
              <div id="flush-collapse${index}" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body">
                  <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex">Account Name <span class="ms-auto"><b>${account.account_name}</b></span></li>
                    <li class="list-group-item d-flex">Account Number <span class="ms-auto"><b>${account.account_no}</b></span></li>
                    <li class="list-group-item d-flex">Account Type <span class="ms-auto"><b>${account.account_type}</b></span></li>
                    <li class="list-group-item d-flex">Account Balance <span class="ms-auto"><b>${account.balance.toFixed(2)}</b></span></li>
                    <li class="list-group-item d-flex">Created at <span class="ms-auto"><b>${new Date(account.createdAt).toLocaleString()}</b></span></li>
                  </ul>
                </div>
              </div>
            `;
    
            accordionContainer.appendChild(accordionItem);


          });
        } catch (error) {
          console.error('An error occurred:', error.message);
        }
      });
      // listener to transfer beneficiary beneSelect senderSelect
      const transferButton = document.getElementById('transferButton');
      transferButton.addEventListener('click', async () => {
        const benef = document.getElementById('beneSelect').value;
        const sender = document.getElementById('senderSelect').value;
        // const paymentAmount = document.querySelector('input[name="payment_amount"]').value;
        const trfAmount = document.querySelector('input[name="transfer_amount"]').value;

            // Check if all required fields are filled
            if (!sender || !trfAmount || !benef) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('http://localhost:9000/api/transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        account_no: benef,
                        sender: sender,
                        amount: trfAmount
                    }),
                });
                console.log(response);
                if (response.status!== 200) {
                    throw new Error('Failed to initiate transfer');
                }

                const responseData = await response.json();
                // Handle the success response here
                console.log('Transfer initiated successfully:', responseData);
                alert('Transfer initiated successfully');
            } catch (error) {
                // Handle errors here
                console.error(error.message);
                console.error('Error initiating transfer:', error.message);
                alert('Failed to initiate transfer. Please try again.');
            }
        });
      document.getElementById("addAccountBtn").addEventListener("click", function () {
            // Get selected values
            const urlSearchParams = new URLSearchParams(window.location.search);
            const userId = urlSearchParams.get('id');
            const accountType = document.getElementById("accountType").value;
            const accountName = document.getElementById("accountName").value;; // You can replace this with the actual account name

            // Check if an account type is selected
            if (!accountType) {
                alert("Please select an account type");
                return;
            }

            // Prepare the request body
            const requestBody = {
                account_type: accountType,
                account_name: accountName,
                user_id: userId
            };
            console.log(requestBody);
            // Send a POST request to /api/createAccount
            fetch("/api/createAccount", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(requestBody),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to add account");
                    }
                    return response.json();
                })
                .then(data => {
                    // Handle the success response here
                    console.log("Account added successfully:", data);
                    alert("Account added successfully");
                    
                    // Reload the page
                    location.reload();
                })
                .catch(error => {
                    // Handle other errors here
                    // console.error("Error adding account:", error.message);
                    if (error.message !== "Account already exists") {
                        alert("Failed to add account. Please try again.");
                        location.reload();
                    }
                    alert("Account already exists");
                    location.reload();
                });
        });
        

        // listener to withdraw 
        const wdrawButton = document.getElementById('wdrawBtn');
        wdrawButton.addEventListener('click', async () => {
            const wdaracc = document.querySelector('input[name="account_wdraw"]').value;
            const wdrawAmount = document.querySelector('input[name="withdraw_amount"]').value;

        

            // Check if all required fields are filled
            if (!wdaracc || !wdrawAmount) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sender: wdaracc,
                        amount: wdrawAmount
                    }),
                });

                if (!response.ok) {
                    if (response.status === 402) {
                      alert('Insufficient balance');
                      throw new Error('Failed to initiate withdraw');
                    }
                    throw new Error('Failed to initiate withdraw');
                }

                const responseData = await response.json();
                // Handle the success response here
                console.log('Transfer initiated successfully:', responseData);
                alert('Transfer initiated successfully');
            } catch (error) {
                // Handle errors here
                console.error('Error initiating transfer:', error.message);
                alert('Failed to initiate transfer. Please try again.');
            }
        });

        const depoButton = document.getElementById('depoBtn');
        depoButton.addEventListener('click', async () => {
            const depoacc = document.querySelector('input[name="account_depo"]').text;
            const depoAmount = document.querySelector('input[name="depo_amount"]').value;

            // Check if all required fields are filled
            if (!depoacc || !depoAmount) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('/api/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sender: senwdaraccder,
                        amount: wdrawAmount
                    }),
                });

                if (!response.ok) {
                    if (response.status === 402) {
                      alert('Insufficient balance');
                      throw new Error('Failed to initiate withdraw');
                    }
                    throw new Error('Failed to initiate withdraw');
                }

                const responseData = await response.json();
                // Handle the success response here
                console.log('Transfer initiated successfully:', responseData);
                alert('Transfer initiated successfully');
            } catch (error) {
                // Handle errors here
                console.error('Error initiating transfer:', error.message);
                alert('Failed to initiate transfer. Please try again.');
            }
        });
    </script>  
</body>
</html>
  


<!-- Display Accounts-->

<!-- Dont Display Account-->