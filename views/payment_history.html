<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap/bootstrap-5.3.2-dist/css/bootstrap.css">
    <link rel="stylesheet" href="css/fontawesome/fontawesome-free-6.4.2-web/css/all.css">
    <link rel="stylesheet" href="css/main.css">
    <script src="js/bootstrap.bundle.js"></script>
    <title>Payment History</title>
</head>
<body>

     <!-- Main Page Header -->
     <header class="main-page-header mb-3 bg-primary">
        <!-- Container-->
        <div class="container d-flex align-items-center">
           <!-- Company Name -->
           <div class="company-name">
              Evergreen Bank
           </div>
           <!-- Company Name -->

           <!-- Navigation -->
           <nav class="navigation">
             <li><a href="/dashboard">Dashboard</a></li>
             <li><a href="">Payment History</a></li>
             <li><a href="/history">Transaction History</a></li>
           </nav>
           <!-- End Of Navigation -->

           <!-- Display Name -->
           <div class="display-name ms-auto text-white">
              <i class="fa fa-circle text-success me-2"></i> Welcome: <span id="name"></span>
           </div>
           <!-- End Of Display Name -->

           <!-- Log Out Button -->
           <a href="" class="btn btn-sm text-white ms-4">
              <i class="fa fa-sign-out-alt"></i><a href="/login" class="btn btn-sm text-white">Sign Out</a> 
           </a>
           <!-- End Of Log Out Button -->
        </div>
        <!-- End of Container-->
    </header>   
    <!-- Payment History Table -->
    <table class="table text-center mb-2 me-2" id="paymentHistoryTable">
        <tr>
            <th>Record Id</th>
            <th>Beneficiary</th>
            <th>Beneficiary Account Number</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Reference Number</th>
            <th>Reason Code</th>
            <th>Created at</th>
        </tr>
        <tbody>
         <!-- Data will be dynamically populated here -->
        </tbody>
    </table>

    <script>
        
      document.addEventListener("DOMContentLoaded", async function () {
          const urlSearchParams = new URLSearchParams(window.location.search);
          const userId = urlSearchParams.get('id');
          const navigationLinks = document.querySelectorAll('.navigation a');
          navigationLinks.forEach(link => {
              const href = link.getAttribute('href');
              link.setAttribute('href', `${href}?id=${userId}`);
          });
          try {
            // Fetch payment history data
            const response = await fetch(`http://localhost:9000/api/user/${userId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch user data');
            }

            const userData = await response.json();
            console.log(userData);
    
            // Display user name
            document.getElementById('name').innerText = `${userData.first_name} ${userData.last_name}`;
          } catch (error) {
              console.error('Error:', error.message);
          }
          try {
              // Fetch payment history data
              const response = await fetch(`http://localhost:9000/api/paymentById/${userId}`);
              if (!response.ok) {
                  throw new Error('Failed to fetch payment history');
              }

              const paymentHistoryData = await response.json();
              console.log(paymentHistoryData);

              // Reference to the table body
              const tableBody = document.getElementById('paymentHistoryTable').getElementsByTagName('tbody')[0];

              // Populate the table rows dynamically
              paymentHistoryData.forEach(account => {
                    account.Transactions.forEach(transaction => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${transaction.id}</td>
                            <td>${transaction.beneficiary_name}</td>
                            <td>${transaction.account_no}</td>
                            <td>${transaction.amount}</td>
                            <td>${transaction.status}</td>
                            <td>${transaction.reference}</td>
                            <td>${transaction.reason}</td>
                            <td>${new Date(transaction.createdAt).toLocaleString()}</td>
                        `;
                    });
                });
          } catch (error) {
              console.error('Error:', error.message);
          }
      });
  </script>

    
</body>
</html>